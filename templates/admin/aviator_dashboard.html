{% extends "admin/admin_base.html" %}
{% load static %}

{% block title %}Aviator Game Dashboard - BetMoto Admin{% endblock %}

{% block extra_css %}
,<link rel="stylesheet" href="{% static 'css/admin/aviator_dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <i class="fas fa-plane"></i>
        Aviator Game Dashboard
    </h1>
    <p class="page-subtitle">Real-time game management and monitoring system</p>
</div>

<!-- Statistics Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-card-header">
            <h3 class="stat-card-title">Total Revenue Today</h3>
            <div class="stat-card-icon" style="background: linear-gradient(135deg, var(--success), var(--secondary));">
                <i class="fas fa-money-bill-wave"></i>
            </div>
        </div>
        <div class="stat-card-value" id="totalRevenue">KES {{ stats.total_revenue_today|floatformat:2 }}</div>
        <div class="stat-card-change positive">
            <i class="fas fa-arrow-up"></i> +12.5% from yesterday
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-card-header">
            <h3 class="stat-card-title">Active Players</h3>
            <div class="stat-card-icon" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark));">
                <i class="fas fa-users"></i>
            </div>
        </div>
        <div class="stat-card-value" id="activePlayers">{{ stats.active_players }}</div>
        <div class="stat-card-change positive">
            <i class="fas fa-arrow-up"></i> +5 new players
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-card-header">
            <h3 class="stat-card-title">Games Today</h3>
            <div class="stat-card-icon" style="background: linear-gradient(135deg, var(--warning), #d97706);">
                <i class="fas fa-gamepad"></i>
            </div>
        </div>
        <div class="stat-card-value" id="gamesToday">{{ stats.active_games_today }}</div>
        <div class="stat-card-change positive">
            <i class="fas fa-arrow-up"></i> +18% from yesterday
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-card-header">
            <h3 class="stat-card-title">House Profit</h3>
            <div class="stat-card-icon" style="background: linear-gradient(135deg, var(--info), #0284c7);">
                <i class="fas fa-chart-line"></i>
            </div>
        </div>
        <div class="stat-card-value" id="houseProfit">KES 0</div>
        <div class="stat-card-change positive">
            <i class="fas fa-arrow-up"></i> Margin: 3.2%
        </div>
    </div>
</div>

<!-- Game Control Panel -->
<div class="game-control-panel">
    <div class="game-status-grid">
        <div class="game-phase">
            <div class="phase-icon">
                <i class="fas fa-{% if current_game.status == 'betting' %}clock{% elif current_game.status == 'flying' %}rocket{% else %}pause{% endif %}"></i>
            </div>
            <div class="phase-title">Game Status</div>
            <div class="phase-value" id="gamePhase">
                {% if current_game %}{{ current_game.status|upper }}{% else %}WAITING{% endif %}
            </div>
        </div>

        <div class="game-phase">
            <div class="phase-icon">
                <i class="fas fa-hashtag"></i>
            </div>
            <div class="phase-title">Round Number</div>
            <div class="phase-value" id="currentRound">
                {% if current_game %}{{ current_game.round_number }}{% else %}0{% endif %}
            </div>
        </div>

        <div class="game-phase">
            <div class="phase-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="phase-title">Active Players</div>
            <div class="phase-value" id="playersInRound">0</div>
        </div>

        <div class="game-phase">
            <div class="phase-icon">
                <i class="fas fa-coins"></i>
            </div>
            <div class="phase-title">Total Bets</div>
            <div class="phase-value" id="totalBets">KES 0</div>
        </div>
    </div>

    <div class="multiplier-display" id="currentMultiplier">
        {% if current_game and current_game.multiplier %}{{ current_game.multiplier }}x{% else %}1.00x{% endif %}
    </div>

    <div class="control-buttons">
        <button class="control-btn success" id="startSystemBtn" {% if engine_running %}disabled{% endif %}>
            <i class="fas fa-play"></i> Start System
        </button>
        <button class="control-btn danger" id="stopSystemBtn" {% if not engine_running %}disabled{% endif %}>
            <i class="fas fa-stop"></i> Stop System
        </button>
        <button class="control-btn warning" id="maintenanceBtn">
            <i class="fas fa-tools"></i> Maintenance
        </button>
        <button class="control-btn" id="forceCrashBtn" {% if not engine_running %}disabled{% endif %}>
            <i class="fas fa-exclamation-triangle"></i> Force Crash
        </button>
    </div>
</div>

<!-- Quick Settings -->
<div class="content-card quick-settings">
    <div class="card-header">
        <h2 class="card-title">
            <i class="fas fa-sliders-h"></i>
            Quick Settings
        </h2>
    </div>
    <div class="card-body">
        <div class="settings-row">
            <div class="form-group">
                <label class="form-label">House Edge (%)</label>
                <input type="number" class="form-input" id="houseEdge" min="1" max="10" step="0.1" 
                       value="{{ game_settings.house_edge|default:3.0 }}">
            </div>
            <div class="form-group">
                <label class="form-label">Betting Duration (seconds)</label>
                <input type="number" class="form-input" id="bettingDuration" min="5" max="30" 
                       value="{{ game_settings.betting_duration|default:10 }}">
            </div>
            <div class="form-group">
                <label class="form-label">Game Interval (seconds)</label>
                <input type="number" class="form-input" id="gameInterval" min="1" max="10" 
                       value="{{ game_settings.game_interval|default:5 }}">
            </div>
        </div>
        <button class="btn btn-primary" id="updateSettingsBtn">
            <i class="fas fa-save"></i> Update Settings
        </button>
    </div>
</div>

<!-- Dashboard Tabs -->
<div class="dashboard-tabs">
    <div class="tab-nav">
        <button class="tab-button active" data-tab="liveBets">
            <i class="fas fa-chart-bar"></i> Live Bets
        </button>
        <button class="tab-button" data-tab="gameHistory">
            <i class="fas fa-history"></i> Game History
        </button>
        <button class="tab-button" data-tab="playerManagement">
            <i class="fas fa-users"></i> Player Management
        </button>
        <button class="tab-button" data-tab="systemLogs">
            <i class="fas fa-list"></i> System Logs
        </button>
    </div>

    <div class="tab-content">
        <!-- Live Bets Tab -->
        <div class="tab-pane active" id="liveBets">
            <h3 style="margin-bottom: 1.5rem;">
                <i class="fas fa-chart-bar"></i> Live Betting Activity
            </h3>
            <div class="live-feed" id="liveBetsFeed">
                <div style="text-align: center; color: var(--gray-500); padding: 2rem;">
                    <div class="loading-spinner" style="border-color: var(--gray-300); border-top-color: var(--primary);"></div>
                    <p style="margin-top: 1rem;">Loading live data...</p>
                </div>
            </div>
        </div>

        <!-- Game History Tab -->
        <div class="tab-pane" id="gameHistory">
            <h3 style="margin-bottom: 1.5rem;">
                <i class="fas fa-history"></i> Recent Game Results
            </h3>
            
            <div class="game-results-grid">
                {% for game in recent_games %}
                <div class="game-result {% if game.multiplier < 2 %}low{% elif game.multiplier < 5 %}medium{% elif game.multiplier < 10 %}high{% else %}extreme{% endif %}">
                    <div class="result-multiplier">{{ game.multiplier }}x</div>
                    <div class="result-round">#{{ game.round_number }}</div>
                </div>
                {% endfor %}
            </div>

            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Round</th>
                            <th>Multiplier</th>
                            <th>Players</th>
                            <th>Total Bets</th>
                            <th>Duration</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody id="gameHistoryTable">
                        {% for game in recent_games %}
                        <tr>
                            <td><strong>#{{ game.round_number }}</strong></td>
                            <td>
                                <span style="color: {% if game.multiplier < 2 %}var(--danger){% elif game.multiplier < 5 %}var(--warning){% elif game.multiplier < 10 %}var(--success){% else %}var(--info){% endif %}; font-weight: 700;">
                                    {{ game.multiplier }}x
                                </span>
                            </td>
                            <td>{{ game.total_players|default:0 }}</td>
                            <td>KES {{ game.total_bet_amount|default:0 }}</td>
                            <td>{{ game.duration|default:0 }}s</td>
                            <td>{{ game.created_at|timesince }} ago</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Player Management Tab -->
        <div class="tab-pane" id="playerManagement">
            <h3 style="margin-bottom: 1.5rem;">
                <i class="fas fa-users"></i> Active Players
            </h3>
            
            <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
                <input type="text" class="form-input" placeholder="Search players..." id="playerSearch" style="flex: 1;">
                <select class="form-input" id="playerFilter" style="width: 200px;">
                    <option value="">All Players</option>
                    <option value="active">Active</option>
                    <option value="suspended">Suspended</option>
                </select>
            </div>

            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Balance</th>
                            <th>Current Bet</th>
                            <th>Status</th>
                            <th>Last Seen</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="playersTable">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 2rem; color: var(--gray-500);">
                                <div class="loading-spinner" style="border-color: var(--gray-300); border-top-color: var(--primary); margin: 0 auto 1rem;"></div>
                                Loading players...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- System Logs Tab -->
        <div class="tab-pane" id="systemLogs">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1.5rem;">
                <h3>
                    <i class="fas fa-list"></i> System Activity Logs
                </h3>
                <button class="btn" id="clearLogsBtn" style="background: var(--gray-100); color: var(--gray-700);">
                    <i class="fas fa-trash"></i> Clear Logs
                </button>
            </div>
            
            <div class="live-feed" id="systemLogsContainer">
                <div style="text-align: center; color: var(--gray-500); padding: 2rem;">
                    <div class="loading-spinner" style="border-color: var(--gray-300); border-top-color: var(--primary);"></div>
                    <p style="margin-top: 1rem;">Loading system logs...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Dashboard functionality
    class AviatorAdminDashboard {
        constructor() {
            this.init();
        }
        
        init() {
            this.bindEvents();
            this.initTabs();
            this.startDataRefresh();
        }
        
        bindEvents() {
            // Control buttons
            document.getElementById('startSystemBtn').addEventListener('click', () => this.startSystem());
            document.getElementById('stopSystemBtn').addEventListener('click', () => this.stopSystem());
            document.getElementById('forceCrashBtn').addEventListener('click', () => this.forceCrash());
            document.getElementById('maintenanceBtn').addEventListener('click', () => this.toggleMaintenance());
            document.getElementById('updateSettingsBtn').addEventListener('click', () => this.updateSettings());
            document.getElementById('clearLogsBtn').addEventListener('click', () => this.clearLogs());
        }
        
        initTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabPanes = document.querySelectorAll('.tab-pane');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.dataset.tab;
                    
                    // Remove active class from all buttons and panes
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabPanes.forEach(pane => pane.classList.remove('active'));
                    
                    // Add active class to clicked button and corresponding pane
                    button.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                });
            });
        }
        
        getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]').value;
        }
        
        async startSystem() {
            try {
                const response = await fetch('/admin-start-system/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCsrfToken()
                    }
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    showAlert('System started successfully!', 'success');
                    this.updateControlButtons('running');
                    updateSystemStatus('running');
                } else {
                    showAlert(data.message || 'Failed to start system', 'danger');
                }
            } catch (error) {
                showAlert('Error starting system: ' + error.message, 'danger');
            }
        }
        
        async stopSystem() {
            if (confirm('Are you sure you want to stop the system? This will end all active games.')) {
                try {
                    const response = await fetch('/admin-stop-system/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': this.getCsrfToken()
                        }
                    });
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        showAlert('System stopped successfully!', 'warning');
                        this.updateControlButtons('stopped');
                        updateSystemStatus('stopped');
                    } else {
                        showAlert(data.message || 'Failed to stop system', 'danger');
                    }
                } catch (error) {
                    showAlert('Error stopping system: ' + error.message, 'danger');
                }
            }
        }
        
        async forceCrash() {
            if (confirm('Are you sure you want to force crash the current game?')) {
                try {
                    const response = await fetch('/admin-force-crash/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': this.getCsrfToken()
                        }
                    });
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        showAlert('Game crashed successfully!', 'info');
                    } else {
                        showAlert(data.message || 'Failed to crash game', 'danger');
                    }
                } catch (error) {
                    showAlert('Error crashing game: ' + error.message, 'danger');
                }
            }
        }
        
        async toggleMaintenance() {
            try {
                const response = await fetch('/admin-toggle-maintenance/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCsrfToken()
                    }
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    showAlert(data.message, 'info');
                } else {
                    showAlert(data.message || 'Failed to toggle maintenance', 'danger');
                }
            } catch (error) {
                showAlert('Error toggling maintenance: ' + error.message, 'danger');
            }
        }
        
        async updateSettings() {
            try {
                const settings = {
                    house_edge: document.getElementById('houseEdge').value,
                    betting_duration: document.getElementById('bettingDuration').value,
                    game_interval: document.getElementById('gameInterval').value
                };
                
                const response = await fetch('/admin-update-settings/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCsrfToken()
                    },
                    body: JSON.stringify(settings)
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    showAlert('Settings updated successfully!', 'success');
                } else {
                    showAlert(data.message || 'Failed to update settings', 'danger');
                }
            } catch (error) {
                showAlert('Error updating settings: ' + error.message, 'danger');
            }
        }
        
        clearLogs() {
            document.getElementById('systemLogsContainer').innerHTML = 
                '<div style="text-align: center; color: var(--gray-500); padding: 2rem;">Logs cleared</div>';
        }
        
        updateControlButtons(status) {
            const startBtn = document.getElementById('startSystemBtn');
            const stopBtn = document.getElementById('stopSystemBtn');
            const crashBtn = document.getElementById('forceCrashBtn');
            
            if (status === 'running') {
                startBtn.disabled = true;
                stopBtn.disabled = false;
                crashBtn.disabled = false;
            } else {
                startBtn.disabled = false;
                stopBtn.disabled = true;
                crashBtn.disabled = true;
            }
        }
        
        async fetchGameData() {
            try {
                const response = await fetch('/admin-game-data/');
                if (response.ok) {
                    const data = await response.json();
                    this.updateDashboard(data);
                }
            } catch (error) {
                console.error('Error fetching game data:', error);
            }
        }
        
        updateDashboard(data) {
            // Update game info
            if (data.current_game) {
                document.getElementById('currentRound').textContent = data.current_game.round_number;
                document.getElementById('currentMultiplier').textContent = data.current_game.multiplier + 'x';
                document.getElementById('playersInRound').textContent = data.current_game.player_count;
                document.getElementById('totalBets').textContent = 'KES ' + data.current_game.total_bets;
                document.getElementById('gamePhase').textContent = data.current_game.status.toUpperCase();
            }
            
            // Update statistics
            if (data.stats) {
                document.getElementById('totalRevenue').textContent = 'KES ' + data.stats.total_revenue;
                document.getElementById('activePlayers').textContent = data.stats.active_players;
                document.getElementById('gamesToday').textContent = data.stats.games_today;
                document.getElementById('houseProfit').textContent = 'KES ' + data.stats.house_profit;
            }
            
            // Update live bets
            if (data.live_bets) {
                this.updateLiveBets(data.live_bets);
            }
            
            // Update system status
            if (data.engine_status) {
                updateSystemStatus(data.engine_status);
                this.updateControlButtons(data.engine_status);
            }
        }
        
        updateLiveBets(bets) {
            const container = document.getElementById('liveBetsFeed');
            if (!bets || bets.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: var(--gray-500); padding: 2rem;">
                        <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p>No active bets at the moment</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = bets.map(bet => `
                <div class="bet-item">
                    <div class="bet-header">
                        <span class="bet-user">${bet.username}</span>
                        <span class="bet-amount">KES ${bet.amount}</span>
                    </div>
                    <div class="bet-info">
                        Auto cash out: ${bet.auto_cash_out ? bet.auto_cash_out + 'x' : 'Manual'}
                    </div>
                </div>
            `).join('');
        }
        
        startDataRefresh() {
            // Refresh every 2 seconds
            setInterval(() => {
                this.fetchGameData();
            }, 2000);
            
            // Initial fetch
            this.fetchGameData();
        }
    }
    
    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
        new AviatorAdminDashboard();
        
        // Add some sample data loading simulation
        setTimeout(() => {
            // Simulate loading players
            const playersTable = document.getElementById('playersTable');
            playersTable.innerHTML = `
                <tr>
                    <td><strong>player123</strong></td>
                    <td>KES 1,250.00</td>
                    <td>KES 100.00</td>
                    <td><span style="padding: 0.25rem 0.5rem; background: #d1fae5; color: #065f46; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">Active</span></td>
                    <td>2 minutes ago</td>
                    <td>
                        <button class="btn" style="padding: 0.5rem; background: var(--gray-100); color: var(--gray-700); font-size: 0.75rem;">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
                <tr>
                    <td><strong>aviator_pro</strong></td>
                    <td>KES 5,800.00</td>
                    <td>KES 500.00</td>
                    <td><span style="padding: 0.25rem 0.5rem; background: #d1fae5; color: #065f46; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">Active</span></td>
                    <td>5 minutes ago</td>
                    <td>
                        <button class="btn" style="padding: 0.5rem; background: var(--gray-100); color: var(--gray-700); font-size: 0.75rem;">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
                <tr>
                    <td><strong>lucky_winner</strong></td>
                    <td>KES 750.00</td>
                    <td>-</td>
                    <td><span style="padding: 0.25rem 0.5rem; background: #fef3c7; color: #92400e; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">Idle</span></td>
                    <td>15 minutes ago</td>
                    <td>
                        <button class="btn" style="padding: 0.5rem; background: var(--gray-100); color: var(--gray-700); font-size: 0.75rem;">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `;
            
            // Simulate loading system logs
            const logsContainer = document.getElementById('systemLogsContainer');
            logsContainer.innerHTML = `
                <div style="font-family: monospace; font-size: 0.875rem;">
                    <div style="padding: 0.5rem; border-bottom: 1px solid var(--gray-200); color: var(--success);">
                        <span style="color: var(--gray-500);">[${new Date().toLocaleTimeString()}]</span> 
                        <span style="font-weight: 600;">[INFO]</span> 
                        Game round #1247 started with 12 players
                    </div>
                    <div style="padding: 0.5rem; border-bottom: 1px solid var(--gray-200); color: var(--primary);">
                        <span style="color: var(--gray-500);">[${new Date(Date.now() - 30000).toLocaleTimeString()}]</span> 
                        <span style="font-weight: 600;">[INFO]</span> 
                        Player 'aviator_pro' placed bet of KES 500
                    </div>
                    <div style="padding: 0.5rem; border-bottom: 1px solid var(--gray-200); color: var(--warning);">
                        <span style="color: var(--gray-500);">[${new Date(Date.now() - 60000).toLocaleTimeString()}]</span> 
                        <span style="font-weight: 600;">[WARN]</span> 
                        High betting volume detected - monitoring system performance
                    </div>
                    <div style="padding: 0.5rem; border-bottom: 1px solid var(--gray-200); color: var(--success);">
                        <span style="color: var(--gray-500);">[${new Date(Date.now() - 90000).toLocaleTimeString()}]</span> 
                        <span style="font-weight: 600;">[INFO]</span> 
                        Game round #1246 ended at 3.45x multiplier
                    </div>
                    <div style="padding: 0.5rem; border-bottom: 1px solid var(--gray-200); color: var(--info);">
                        <span style="color: var(--gray-500);">[${new Date(Date.now() - 120000).toLocaleTimeString()}]</span> 
                        <span style="font-weight: 600;">[INFO]</span> 
                        System health check completed - all services operational
                    </div>
                </div>
            `;
            
            // Simulate live bets
            const liveBetsContainer = document.getElementById('liveBetsFeed');
            liveBetsContainer.innerHTML = `
                <div class="bet-item">
                    <div class="bet-header">
                        <span class="bet-user">player123</span>
                        <span class="bet-amount">KES 100</span>
                    </div>
                    <div class="bet-info">Auto cash out: 2.50x</div>
                </div>
                <div class="bet-item">
                    <div class="bet-header">
                        <span class="bet-user">aviator_pro</span>
                        <span class="bet-amount">KES 500</span>
                    </div>
                    <div class="bet-info">Auto cash out: Manual</div>
                </div>
                <div class="bet-item">
                    <div class="bet-header">
                        <span class="bet-user">big_winner</span>
                        <span class="bet-amount">KES 250</span>
                    </div>
                    <div class="bet-info">Auto cash out: 5.00x</div>
                </div>
                <div class="bet-item">
                    <div class="bet-header">
                        <span class="bet-user">lucky_seven</span>
                        <span class="bet-amount">KES 75</span>
                    </div>
                    <div class="bet-info">Auto cash out: 1.50x</div>
                </div>
            `;
        }, 1500);
    });
</script>
{% endblock %}